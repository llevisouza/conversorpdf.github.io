<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to PDF Converter</title>
    <link rel="stylesheet" href="style.css">
</head>
<header>
    <ul class="cores-topo">
    <li>&nbsp;</li>
    <li>&nbsp;</li>
    <li>&nbsp;</li>
    </ul>
</header>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="/img/marca-salvadorcard.png" alt="Logo">
        </div>
        <ul class="navbar-menu">
            <li><a href="#home">Home</a></li>
            <li><a href="#about">Sobre</a></li>
            <li><a href="#services">Serviços</a></li>
            <li><a href="#contact">Contato</a></li>
        </ul>
    </nav>
    <div class="container">
        <h1>Conversor de Imagens</h1>
        <label for="fileInput">Selecionar Imagens:</label>
        <input type="file" id="fileInput" accept="image/jpeg, image/jpg" multiple>
        
        <button id="convertBtn">Converter PDF</button>
        <p id="status"></p>
        <footer class="footer"></footer>
            <p>Desenvolvido por Levi.</p>
        </footer>
    </div>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        document.getElementById('convertBtn').addEventListener('click', async function () {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;

            if (files.length === 0) {
                alert("Por favor, selecione alguns arquivos de imagem.");
                return;
            }

            const zip = new JSZip();
            let convertedCount = 0;
            const totalFiles = files.length;
            const batchSize = 10; // Número de imagens a processar por vez
            const delay = 100; // Delay em milissegundos entre conversões

            document.getElementById('status').innerText = `Converting... ${convertedCount} of ${totalFiles}`;

            async function processBatch(startIndex) {
                for (let i = startIndex; i < Math.min(startIndex + batchSize, files.length); i++) {
                    const file = files[i];
                    if (!file.type.match('image/jpeg') && !file.type.match('image/jpg')) {
                        alert(`Tipo de arquivo não suportado: ${file.name}`);
                        continue;
                    }

                    const imgData = await readFile(file);
                    const img = new Image();
                    img.src = imgData;

                    await new Promise((resolve) => {
                        img.onload = function () {
                            const imgWidth = img.width;
                            const imgHeight = img.height;

                            const pdfWidth = imgWidth * 0.264583;
                            const pdfHeight = imgHeight * 0.264583;

                            const { jsPDF } = window.jspdf;
                            const orientation = imgWidth > imgHeight ? 'landscape' : 'portrait';
                            const doc = new jsPDF(orientation, 'mm', [pdfWidth, pdfHeight]);

                            doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

                            const pdfFilename = file.name.replace(/\.[^/.]+$/, "") + ".pdf";
                            const pdfData = doc.output('blob');

                            zip.file(pdfFilename, pdfData);
                            
                            convertedCount++;
                            console.log("Converted: " + pdfFilename);
                            document.getElementById('status').innerText = `Converting... ${convertedCount} of ${totalFiles}`;

                            resolve(); // Indicar que a conversão está completa
                        };

                        img.onerror = function () {
                            console.error("Erro ao carregar imagem: " + file.name);
                            alert("Erro ao carregar imagem: " + file.name);
                            resolve(); // Continuar mesmo com erro
                        };
                    });

                    // Adiciona um delay entre as conversões
                    await new Promise(resolve => setTimeout(resolve, delay));
                }

                if (startIndex + batchSize < files.length) {
                    await processBatch(startIndex + batchSize);
                }
            }

            await processBatch(0); // Iniciar o processamento
            
            // Criar o arquivo ZIP e iniciar o download
            zip.generateAsync({ type: "blob" }).then(function (content) {
                const zipFilename = "converted_images.zip";
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = zipFilename;
                link.click();
                alert("Conversão completa! Total convertido: " + convertedCount);
                document.getElementById('status').innerText = ""; // Limpar o status após a conclusão
            });
        });

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = () => reject(new Error("Erro ao ler o arquivo: " + file.name));
                reader.readAsDataURL(file);
            });
        }
    </script>
    <footer class="footer">
        <p>Todos os direitos reservados. 2024</p>
    </footer>
</body>
</html>
